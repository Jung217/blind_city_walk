<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI 導覽助手</title>
    <style>
        :root { --primary: #10a37f; --danger: #ef4444; --bg: #000000; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #app { width: 100%; max-width: 500px; text-align: center; }
        h1 { color: var(--primary); font-size: 1.5rem; }
        
        /* 影片視窗 */
        #video-container { width: 100%; border-radius: 20px; overflow: hidden; border: 2px solid #333; background: #111; aspect-ratio: 3/4; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* 狀態文字區 */
        #status-box { margin: 20px 0; padding: 20px; border-radius: 15px; background: #1a1a1a; min-height: 100px; font-size: 1.3rem; border: 1px solid #444; display: flex; align-items: center; justify-content: center; }
        
        /* 按鈕與輸入 */
        .controls { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        input { padding: 15px; border-radius: 10px; border: 1px solid #444; background: #222; color: white; font-size: 1rem; width: 100%; box-sizing: border-box; }
        button { padding: 20px; font-size: 1.5rem; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; transition: 0.2s; }
        #startBtn { background: var(--primary); color: white; }
        #stopBtn { background: var(--danger); color: white; }
        
        canvas { display: none; }
    </style>
</head>
<body>

<div id="app">
    <h1>City Walk AI 助手 (OpenAI)</h1>
    
    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="status-box" id="statusText">請輸入 OpenAI API Key 後點擊啟動</div>

    <div class="controls">
        <input type="password" id="apiKey" placeholder="在此輸入 OpenAI API Key (sk-...)">
        <button id="startBtn">啟動導覽</button>
        <button id="stopBtn">停止導覽</button>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusBox = document.getElementById('status-box');
    const apiKeyInput = document.getElementById('apiKey');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    let intervalId = null;
    let isProcessing = false;

    // 自動讀取儲存的金鑰
    const savedKey = localStorage.getItem('openai_key');
    if (savedKey) {
        apiKeyInput.value = savedKey;
        statusBox.innerText = "已載入金鑰，請點擊啟動。";
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        msg.rate = 1.1; 
        window.speechSynthesis.speak(msg);
    }

    async function startApp() {
        const key = apiKeyInput.value.trim();
        if (!key.startsWith('sk-')) {
            speak("API 金鑰格式似乎不正確，請重新檢查。");
            return;
        }
        localStorage.setItem('openai_key', key);

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            statusBox.innerText = "正在連線 AI...";
            speak("系統已啟動，開始為您導航。");
            
            // 每 6 秒辨識一次，GPT-4o 辨識較深，這頻率能維持較好體驗
            intervalId = setInterval(analyzeScene, 6000);
        } catch (err) {
            console.error(err);
            speak("無法開啟相機，請確保網址為 HTTPS 並已授權權限。");
        }
    }

    async function analyzeScene() {
        if (isProcessing) return;
        isProcessing = true;
        statusBox.innerText = "掃描中...";

        // 截圖
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        const base64Img = canvas.toDataURL('image/jpeg', 0.6); // 稍微壓縮降低流量

        const apiKey = apiKeyInput.value.trim();

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "你是一位視障者的眼睛。請看這張照片，描述前方 3 公尺內的關鍵障礙物（如：階梯、電線桿、車、行人）。如果路徑安全，請說'前方安全，請直走'。如果有危險請明確指出方向。請用一句話概括，不超過 25 個字。" },
                                { type: "image_url", image_url: { url: base64Img } }
                            ]
                        }
                    ],
                    max_tokens: 100
                })
            });

            const data = await response.json();

            if (response.status === 200) {
                const result = data.choices[0].message.content;
                statusBox.innerText = result;
                speak(result);
            } else {
                // OpenAI 錯誤處理
                let errorDesc = "連線異常";
                if (response.status === 401) errorDesc = "金鑰無效，請檢查輸入是否正確。";
                else if (response.status === 429) errorDesc = "額度已用完或請求太頻繁。";
                else if (data.error) errorDesc = data.error.message;

                statusBox.innerText = "錯誤: " + response.status;
                speak(errorDesc);
            }
        } catch (e) {
            statusBox.innerText = "網路連線失敗";
            speak("網路連線失敗，請檢查網路。");
        } finally {
            isProcessing = false;
        }
    }

    startBtn.onclick = startApp;
    stopBtn.onclick = () => {
        clearInterval(intervalId);
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        statusBox.innerText = "已停止導覽";
        speak("導覽已停止。");
    };
</script>

</body>
</html>
